{"ast":null,"code":"'use strict';\n\nconst AbstractConnectionManager = require('../abstract/connection-manager');\n\nconst SequelizeErrors = require('../../errors');\n\nconst Promise = require('../../promise');\n\nconst {\n  logger\n} = require('../../utils/logger');\n\nconst DataTypes = require('../../data-types').mariadb;\n\nconst momentTz = require('moment-timezone');\n\nconst debug = logger.debugContext('connection:mariadb');\n\nconst parserStore = require('../parserStore')('mariadb');\n/**\n * MariaDB Connection Manager\n *\n * Get connections, validate and disconnect them.\n * AbstractConnectionManager pooling use it to handle MariaDB specific connections\n * Use https://github.com/MariaDB/mariadb-connector-nodejs to connect with MariaDB server\n *\n * @extends AbstractConnectionManager\n * @returns Class<ConnectionManager>\n * @private\n */\n\n\nclass ConnectionManager extends AbstractConnectionManager {\n  constructor(dialect, sequelize) {\n    sequelize.config.port = sequelize.config.port || 3306;\n    super(dialect, sequelize);\n    this.lib = this._loadDialectModule('mariadb');\n    this.refreshTypeParser(DataTypes);\n  }\n\n  static _typecast(field, next) {\n    if (parserStore.get(field.type)) {\n      return parserStore.get(field.type)(field, this.sequelize.options, next);\n    }\n\n    return next();\n  }\n\n  _refreshTypeParser(dataType) {\n    parserStore.refresh(dataType);\n  }\n\n  _clearTypeParser() {\n    parserStore.clear();\n  }\n  /**\n   * Connect with MariaDB database based on config, Handle any errors in connection\n   * Set the pool handlers on connection.error\n   * Also set proper timezone once connection is connected.\n   *\n   * @param {Object} config\n   * @returns {Promise<Connection>}\n   * @private\n   */\n\n\n  connect(config) {\n    // Named timezone is not supported in mariadb, convert to offset\n    let tzOffset = this.sequelize.options.timezone;\n    tzOffset = /\\//.test(tzOffset) ? momentTz.tz(tzOffset).format('Z') : tzOffset;\n    const connectionConfig = {\n      host: config.host,\n      port: config.port,\n      user: config.username,\n      password: config.password,\n      database: config.database,\n      timezone: tzOffset,\n      typeCast: ConnectionManager._typecast.bind(this),\n      bigNumberStrings: false,\n      supportBigNumbers: true,\n      foundRows: false\n    };\n\n    if (config.dialectOptions) {\n      Object.assign(connectionConfig, config.dialectOptions);\n    }\n\n    if (!this.sequelize.config.keepDefaultTimezone) {\n      // set timezone for this connection\n      if (connectionConfig.initSql) {\n        if (!Array.isArray(connectionConfig.initSql)) {\n          connectionConfig.initSql = [connectionConfig.initSql];\n        }\n\n        connectionConfig.initSql.push(`SET time_zone = '${tzOffset}'`);\n      } else {\n        connectionConfig.initSql = `SET time_zone = '${tzOffset}'`;\n      }\n    }\n\n    return this.lib.createConnection(connectionConfig).then(connection => {\n      this.sequelize.options.databaseVersion = connection.serverVersion();\n      debug('connection acquired');\n      connection.on('error', error => {\n        switch (error.code) {\n          case 'ESOCKET':\n          case 'ECONNRESET':\n          case 'EPIPE':\n          case 'PROTOCOL_CONNECTION_LOST':\n            this.pool.destroy(connection);\n        }\n      });\n      return connection;\n    }).catch(err => {\n      switch (err.code) {\n        case 'ECONNREFUSED':\n          throw new SequelizeErrors.ConnectionRefusedError(err);\n\n        case 'ER_ACCESS_DENIED_ERROR':\n        case 'ER_ACCESS_DENIED_NO_PASSWORD_ERROR':\n          throw new SequelizeErrors.AccessDeniedError(err);\n\n        case 'ENOTFOUND':\n          throw new SequelizeErrors.HostNotFoundError(err);\n\n        case 'EHOSTUNREACH':\n        case 'ENETUNREACH':\n        case 'EADDRNOTAVAIL':\n          throw new SequelizeErrors.HostNotReachableError(err);\n\n        case 'EINVAL':\n          throw new SequelizeErrors.InvalidConnectionError(err);\n\n        default:\n          throw new SequelizeErrors.ConnectionError(err);\n      }\n    });\n  }\n\n  disconnect(connection) {\n    // Don't disconnect connections with CLOSED state\n    if (!connection.isValid()) {\n      debug('connection tried to disconnect but was already at CLOSED state');\n      return Promise.resolve();\n    } //wrap native Promise into bluebird\n\n\n    return Promise.resolve(connection.end());\n  }\n\n  validate(connection) {\n    return connection && connection.isValid();\n  }\n\n}\n\nmodule.exports = ConnectionManager;\nmodule.exports.ConnectionManager = ConnectionManager;\nmodule.exports.default = ConnectionManager;","map":{"version":3,"names":["AbstractConnectionManager","require","SequelizeErrors","Promise","logger","DataTypes","mariadb","momentTz","debug","debugContext","parserStore","ConnectionManager","constructor","dialect","sequelize","config","port","lib","_loadDialectModule","refreshTypeParser","_typecast","field","next","get","type","options","_refreshTypeParser","dataType","refresh","_clearTypeParser","clear","connect","tzOffset","timezone","test","tz","format","connectionConfig","host","user","username","password","database","typeCast","bind","bigNumberStrings","supportBigNumbers","foundRows","dialectOptions","Object","assign","keepDefaultTimezone","initSql","Array","isArray","push","createConnection","then","connection","databaseVersion","serverVersion","on","error","code","pool","destroy","catch","err","ConnectionRefusedError","AccessDeniedError","HostNotFoundError","HostNotReachableError","InvalidConnectionError","ConnectionError","disconnect","isValid","resolve","end","validate","module","exports","default"],"sources":["/home/brian/node_modules/sequelize/lib/dialects/mariadb/connection-manager.js"],"sourcesContent":["'use strict';\n\nconst AbstractConnectionManager = require('../abstract/connection-manager');\nconst SequelizeErrors = require('../../errors');\nconst Promise = require('../../promise');\nconst { logger } = require('../../utils/logger');\nconst DataTypes = require('../../data-types').mariadb;\nconst momentTz = require('moment-timezone');\nconst debug = logger.debugContext('connection:mariadb');\nconst parserStore = require('../parserStore')('mariadb');\n\n/**\n * MariaDB Connection Manager\n *\n * Get connections, validate and disconnect them.\n * AbstractConnectionManager pooling use it to handle MariaDB specific connections\n * Use https://github.com/MariaDB/mariadb-connector-nodejs to connect with MariaDB server\n *\n * @extends AbstractConnectionManager\n * @returns Class<ConnectionManager>\n * @private\n */\n\nclass ConnectionManager extends AbstractConnectionManager {\n  constructor(dialect, sequelize) {\n    sequelize.config.port = sequelize.config.port || 3306;\n    super(dialect, sequelize);\n    this.lib = this._loadDialectModule('mariadb');\n    this.refreshTypeParser(DataTypes);\n  }\n\n  static _typecast(field, next) {\n    if (parserStore.get(field.type)) {\n      return parserStore.get(field.type)(field, this.sequelize.options, next);\n    }\n    return next();\n  }\n\n  _refreshTypeParser(dataType) {\n    parserStore.refresh(dataType);\n  }\n\n  _clearTypeParser() {\n    parserStore.clear();\n  }\n\n  /**\n   * Connect with MariaDB database based on config, Handle any errors in connection\n   * Set the pool handlers on connection.error\n   * Also set proper timezone once connection is connected.\n   *\n   * @param {Object} config\n   * @returns {Promise<Connection>}\n   * @private\n   */\n  connect(config) {\n    // Named timezone is not supported in mariadb, convert to offset\n    let tzOffset = this.sequelize.options.timezone;\n    tzOffset = /\\//.test(tzOffset) ? momentTz.tz(tzOffset).format('Z')\n      : tzOffset;\n\n    const connectionConfig = {\n      host: config.host,\n      port: config.port,\n      user: config.username,\n      password: config.password,\n      database: config.database,\n      timezone: tzOffset,\n      typeCast: ConnectionManager._typecast.bind(this),\n      bigNumberStrings: false,\n      supportBigNumbers: true,\n      foundRows: false\n    };\n\n    if (config.dialectOptions) {\n      Object.assign(connectionConfig, config.dialectOptions);\n    }\n\n    if (!this.sequelize.config.keepDefaultTimezone) {\n      // set timezone for this connection\n      if (connectionConfig.initSql) {\n        if (!Array.isArray(\n          connectionConfig.initSql)) {\n          connectionConfig.initSql = [connectionConfig.initSql];\n        }\n        connectionConfig.initSql.push(`SET time_zone = '${tzOffset}'`);\n      } else {\n        connectionConfig.initSql = `SET time_zone = '${tzOffset}'`;\n      }\n    }\n\n    return this.lib.createConnection(connectionConfig)\n      .then(connection => {\n        this.sequelize.options.databaseVersion = connection.serverVersion();\n        debug('connection acquired');\n        connection.on('error', error => {\n          switch (error.code) {\n            case 'ESOCKET':\n            case 'ECONNRESET':\n            case 'EPIPE':\n            case 'PROTOCOL_CONNECTION_LOST':\n              this.pool.destroy(connection);\n          }\n        });\n        return connection;\n      })\n      .catch(err => {\n        switch (err.code) {\n          case 'ECONNREFUSED':\n            throw new SequelizeErrors.ConnectionRefusedError(err);\n          case 'ER_ACCESS_DENIED_ERROR':\n          case 'ER_ACCESS_DENIED_NO_PASSWORD_ERROR':\n            throw new SequelizeErrors.AccessDeniedError(err);\n          case 'ENOTFOUND':\n            throw new SequelizeErrors.HostNotFoundError(err);\n          case 'EHOSTUNREACH':\n          case 'ENETUNREACH':\n          case 'EADDRNOTAVAIL':\n            throw new SequelizeErrors.HostNotReachableError(err);\n          case 'EINVAL':\n            throw new SequelizeErrors.InvalidConnectionError(err);\n          default:\n            throw new SequelizeErrors.ConnectionError(err);\n        }\n      });\n  }\n\n  disconnect(connection) {\n    // Don't disconnect connections with CLOSED state\n    if (!connection.isValid()) {\n      debug('connection tried to disconnect but was already at CLOSED state');\n      return Promise.resolve();\n    }\n    //wrap native Promise into bluebird\n    return Promise.resolve(connection.end());\n  }\n\n  validate(connection) {\n    return connection && connection.isValid();\n  }\n}\n\nmodule.exports = ConnectionManager;\nmodule.exports.ConnectionManager = ConnectionManager;\nmodule.exports.default = ConnectionManager;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}